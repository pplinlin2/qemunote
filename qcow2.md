# QCOW2
### qcow2 format
* [block/qcow2.h] - struct QCowHeader

|Byte1|Byte2|Byte3|Byte4|
|-|-|-|-|
|magic|version|backing_file_offset|...|
|backing_file_size|cluster_bits|size|...|
|crypt_method|l1_size|l1_table_offset|...|
|refcount_table_offset|...| efcount_table_clusters|nb_snapshots|
|snapshots_offset|...|

* [block/qcow2.h] - struct QCowSnapshotHeader

|Byte1|Byte2|Byte3|Byte4|
|-|-|-|-|
|l1_table_offset|...|l1_size|id_str_size & name_size|
|date_sec|date_nsec|vm_clock_nsec|...|
|vm_state_size|extra_data_size|||

/* extra data, id_str and name follows  */


### experiment
* Create a new file
  * 00 00 00 00 00 03 00 00 指向L1 table
  * 00 00 00 00 00 01 00 00 指向refcount table
  * 00 00 00 00 00 02 00 00 指向refcount block
  * refcount block 0, 1, 2, 3 值為 1
```
[~] # qemu-img create -f qcow2 base.qcow2 1M
[~] # hexdump -C base.qcow2
00000000  51 46 49 fb 00 00 00 03  00 00 00 00 00 00 00 00  |QFI.............|
00000010  00 00 00 00 00 00 00 10  00 00 00 00 00 10 00 00  |................|
00000020  00 00 00 00 00 00 00 01  00 00 00 00 00 03 00 00  |................|
00000030  00 00 00 00 00 01 00 00  00 00 00 01 00 00 00 00  |................|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000060  00 00 00 04 00 00 00 68  00 00 00 00 00 00 00 00  |.......h........|
00000070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00010000  00 00 00 00 00 02 00 00  00 00 00 00 00 00 00 00  |................|
00010010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00020000  00 01 00 01 00 01 00 01  00 00 00 00 00 00 00 00  |................|
00020010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00030200
```
 ![qcow2_step1](https://github.com/pplinlin2/qemunote/blob/master/static/img/step1.png?raw=true)
* Write some guest data
  * 00 00 00 00 00 04 00 00 指向L2 table
  * L2 table[7]: 地址7 * 64K ~ 8 * 64K的內容在 00 00 00 00 00 05 00 00
  * L2 table[8]: 地址8 * 64K ~ 9 * 64K的內容在 00 00 00 00 00 06 00 00
  * L2 table[9]: 地址9 * 64K ~ a * 64K的內容在 00 00 00 00 00 07 00 00
  * refcount block 0 ~ 7 值為 1
```
[~] # qemu-io -c "write $((512*1024 - 512)) $((65*1024))" base.qcow2
[~] # hexdump -C base.qcow2
00000000  51 46 49 fb 00 00 00 03  00 00 00 00 00 00 00 00  |QFI.............|
00000010  00 00 00 00 00 00 00 10  00 00 00 00 00 10 00 00  |................|
00000020  00 00 00 00 00 00 00 01  00 00 00 00 00 03 00 00  |................|
00000030  00 00 00 00 00 01 00 00  00 00 00 01 00 00 00 00  |................|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000060  00 00 00 04 00 00 00 68  00 00 00 00 00 00 00 00  |.......h........|
00000070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00010000  00 00 00 00 00 02 00 00  00 00 00 00 00 00 00 00  |................|
00010010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00020000  00 01 00 01 00 01 00 01  00 01 00 01 00 01 00 01  |................|
00020010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00030000  80 00 00 00 00 04 00 00  00 00 00 00 00 00 00 00  |................|
00030010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00040030  00 00 00 00 00 00 00 00  80 00 00 00 00 05 00 00  |................|
00040040  80 00 00 00 00 06 00 00  80 00 00 00 00 07 00 00  |................|
00040050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
0005fe00  cd cd cd cd cd cd cd cd  cd cd cd cd cd cd cd cd  |................|
*
00070200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00080000
```
 ![qcow2_step2](https://github.com/pplinlin2/qemunote/blob/master/static/img/step2.png?raw=true)
 ![qcow2_step2-1](https://github.com/pplinlin2/qemunote/blob/master/static/img/step2-1.png?raw=true)
* Create an internal snapshot
  * 00 00 00 00 00 09 00 00 指向snapshot table
  * 00 00 00 00 00 08 00 00 指向snapshot的L1 table
  * snapshot的L1 table的L2 table為 00 00 00 00 00 04 00 00
  * snpashot的id_str為1，snapshot的name為one
  * refcount block 0 ~ 3, 8, 9 值為 1
  * refcount block 4 ~ 7 值為 2
```
[~] # qemu-img snapshot -c one base.qcow2
[~] # hexdump -C base.qcow2
00000000  51 46 49 fb 00 00 00 03  00 00 00 00 00 00 00 00  |QFI.............|
00000010  00 00 00 00 00 00 00 10  00 00 00 00 00 10 00 00  |................|
00000020  00 00 00 00 00 00 00 01  00 00 00 00 00 03 00 00  |................|
00000030  00 00 00 00 00 01 00 00  00 00 00 01 00 00 00 01  |................|
00000040  00 00 00 00 00 09 00 00  00 00 00 00 00 00 00 00  |................|
00000050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000060  00 00 00 04 00 00 00 68  00 00 00 00 00 00 00 00  |.......h........|
00000070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00010000  00 00 00 00 00 02 00 00  00 00 00 00 00 00 00 00  |................|
00010010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00020000  00 01 00 01 00 01 00 01  00 02 00 02 00 02 00 02  |................|
00020010  00 01 00 01 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00020020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00030000  00 00 00 00 00 04 00 00  00 00 00 00 00 00 00 00  |................|
00030010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00040030  00 00 00 00 00 00 00 00  00 00 00 00 00 05 00 00  |................|
00040040  00 00 00 00 00 06 00 00  00 00 00 00 00 07 00 00  |................|
00040050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
0005fe00  cd cd cd cd cd cd cd cd  cd cd cd cd cd cd cd cd  |................|
*
00070200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00080000  80 00 00 00 00 04 00 00  00 00 00 00 00 00 00 00  |................|
00080010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00090000  00 00 00 00 00 08 00 00  00 00 00 01 00 01 00 03  |................|
00090010  58 00 7b 37 1e 99 ff e8  00 00 00 00 00 00 00 00  |X.{7............|
00090020  00 00 00 00 00 00 00 10  00 00 00 00 00 00 00 00  |................|
00090030  00 00 00 00 00 10 00 00  31 6f 6e 65 00 00 00 00  |........1one....|
00090040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00090200
```
 ![qcow2_step3](https://github.com/pplinlin2/qemunote/blob/master/static/img/step3.png?raw=true)
* Write more guest data
  * L1 table 改指向 00 00 00 00 00 0a 00 00
  * L2 table[7]: 地址7 * 64K ~ 8 * 64K的內容改在 00 00 00 00 00 0b 00 00
  * refcount block 0 ~ 5, 8 ~ 11 值為 1
  * refcount block 6, 7 值為 2
```
[~] # qemu-io -c "write $((512*1024 - 64*1024 + 512)) 512)" base.qcow2
[~] # hexdump -C base.qcow2
00000000  51 46 49 fb 00 00 00 03  00 00 00 00 00 00 00 00  |QFI.............|
00000010  00 00 00 00 00 00 00 10  00 00 00 00 00 10 00 00  |................|
00000020  00 00 00 00 00 00 00 01  00 00 00 00 00 03 00 00  |................|
00000030  00 00 00 00 00 01 00 00  00 00 00 01 00 00 00 01  |................|
00000040  00 00 00 00 00 09 00 00  00 00 00 00 00 00 00 00  |................|
00000050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000060  00 00 00 04 00 00 00 68  00 00 00 00 00 00 00 00  |.......h........|
00000070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00010000  00 00 00 00 00 02 00 00  00 00 00 00 00 00 00 00  |................|
00010010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00020000  00 01 00 01 00 01 00 01  00 01 00 01 00 02 00 02  |................|
00020010  00 01 00 01 00 01 00 01  00 00 00 00 00 00 00 00  |................|
00020020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00030000  80 00 00 00 00 0a 00 00  00 00 00 00 00 00 00 00  |................|
00030010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00040030  00 00 00 00 00 00 00 00  00 00 00 00 00 05 00 00  |................|
00040040  00 00 00 00 00 06 00 00  00 00 00 00 00 07 00 00  |................|
00040050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
0005fe00  cd cd cd cd cd cd cd cd  cd cd cd cd cd cd cd cd  |................|
*
00070200  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00080000  80 00 00 00 00 04 00 00  00 00 00 00 00 00 00 00  |................|
00080010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00090000  00 00 00 00 00 08 00 00  00 00 00 01 00 01 00 03  |................|
00090010  58 00 7b 37 1e 99 ff e8  00 00 00 00 00 00 00 00  |X.{7............|
00090020  00 00 00 00 00 00 00 10  00 00 00 00 00 00 00 00  |................|
00090030  00 00 00 00 00 10 00 00  31 6f 6e 65 00 00 00 00  |........1one....|
00090040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
000a0030  00 00 00 00 00 00 00 00  80 00 00 00 00 0b 00 00  |................|
000a0040  00 00 00 00 00 06 00 00  00 00 00 00 00 07 00 00  |................|
000a0050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
000b0200  cd cd cd cd cd cd cd cd  cd cd cd cd cd cd cd cd  |................|
*
000b0400  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
000bfe00  cd cd cd cd cd cd cd cd  cd cd cd cd cd cd cd cd  |................|
*
000c0000
```
 ![qcow2_step4](https://github.com/pplinlin2/qemunote/blob/master/static/img/step4.png?raw=true)
 ![qcow2_step4-1](https://github.com/pplinlin2/qemunote/blob/master/static/img/step4-1.png?raw=true)


### Reference:

 * [qcow2](http://events.linuxfoundation.org/sites/events/files/slides/2015-qcow2-expanded.pdf) Backing Chain Management in libvirt and qemu
